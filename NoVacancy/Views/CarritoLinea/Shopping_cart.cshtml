@model List<NoVacancy.ViewModels.CarritoLineaViewModel>
<div class="container my-5">
	<h3 class="fw-bold mb-4">Tu carrito</h3>

	<!-- Encabezado de tabla -->
	<div class="row fw-bold border-bottom pb-2 mb-3">
		<div class="col-md-6">Producto</div>
		<div class="col-md-3 text-center">Cantidad</div>
		<div class="col-md-3 text-end">Total</div>
	</div>

	@if (TempData["Error"] != null)
	{
		<div class="alert alert-danger">@TempData["Error"]</div>
	}

	@{
		double total = 0;
	}
	@if (Model != null && Model.Count > 0)
	{
		foreach (var item in Model)
		{
			double subtotal = (item.CarritoLinea.Producto?.precio ?? 0) * item.CarritoLinea.cantidad;
			total += subtotal;
			var color = item.CarritoLinea.Producto?.Color?.nombre ?? "-";
			var talla = item.CarritoLinea.Producto?.Talla?.nombre ?? "-";
			var imagen = item.ImagenPrincipal;
			int? limite = item.CarritoLinea.Producto?.limite;
			<div class="row align-items-center mb-4">
				<div class="col-md-6 d-flex">
					<img src="@imagen" style="width: 80px; height: 80px; object-fit: cover;" alt="@item.CarritoLinea.Producto?.nombre" class="me-3">
					<div>
						<div class="fw-bold">@item.CarritoLinea.Producto?.nombre</div>
						<div class="text-muted">$@String.Format("{0:0.00}", item.CarritoLinea.Producto?.precio ?? 0)</div>
						<div class="text-muted">Color: @item.Color</div>
						<div class="text-muted">Talla: @item.Talla</div>
						@if (limite.HasValue)
						{
							<div class="text-danger small">Máximo por cliente: @limite.Value</div>
						}
					</div>
				</div>
				<div class="col-md-3 text-center">
					<div class="d-flex justify-content-center align-items-center">
						<form asp-action="Update" asp-controller="CarritoLinea" method="post" class="d-inline">
							<input type="hidden" name="idProducto" value="@item.CarritoLinea.idProducto" />
							<input type="hidden" name="cantidad" value="@(item.CarritoLinea.cantidad - 1)" />
							<button class="qty-btn" type="submit" @(item.CarritoLinea.cantidad <= 1 ? "disabled" : "")>−</button>
						</form>
						<span class="mx-2">@item.CarritoLinea.cantidad</span>
						<form asp-action="Update" asp-controller="CarritoLinea" method="post" class="d-inline">
							<input type="hidden" name="idProducto" value="@item.CarritoLinea.idProducto" />
							<input type="hidden" name="cantidad" value="@(item.CarritoLinea.cantidad + 1)" />
							<button class="qty-btn" type="submit" @(limite.HasValue && item.CarritoLinea.cantidad >= limite.Value ? "disabled" : "")>+</button>
						</form>
						<form asp-action="Delete" asp-controller="CarritoLinea" method="post" class="d-inline ms-3">
							<input type="hidden" name="idProducto" value="@item.CarritoLinea.idProducto" />
							<button type="submit" class="btn btn-link p-0 delete-icon" title="Eliminar" style="color: #dc3545;"><i class="bi bi-trash"></i></button>
						</form>
					</div>
				</div>
				<div class="col-md-3 text-end fw-bold">$@String.Format("{0:0.00}", subtotal)</div>
			</div>
		}
	}
	else
	{
		<div class="alert alert-info">Tu carrito está vacío.</div>
	}

	<!-- Total -->
	<div class="row justify-content-end mb-3">
		<div class="col-md-3 text-end fw-bold">
			Total: $@String.Format("{0:0.00}", total) MXN
		</div>
	</div>

	<!-- Botones -->
	<div class="container my-4">
		<div class="row justify-content-end">
			<div class="col">
				<button class="btn btn-dark w-100" type="button" data-bs-toggle="modal" data-bs-target="#facturaModal" @(Model == null || !Model.Any() ? "disabled" : "")>Confirmar pedido</button>
			</div>
		</div>
	</div>

	<!-- Modal para solicitar factura -->
	<div class="modal fade" id="facturaModal" tabindex="-1" aria-labelledby="facturaModalLabel" aria-hidden="true">
	  <div class="modal-dialog">
	    <div class="modal-content">
	      <div class="modal-header">
	        <h5 class="modal-title" id="facturaModalLabel">¿Deseas solicitar factura?</h5>
	        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
	      </div>
	      <div class="modal-body">
	        Selecciona una opción para continuar con tu pedido.
	      </div>
	      <div class="modal-footer">
	        <form asp-action="ConfirmarPedido" asp-controller="CarritoCabecera" method="post" class="d-inline">
	          <input type="hidden" name="solicitarFactura" value="true" />
	          <button type="submit" class="btn btn-primary">Solicitar factura</button>
	        </form>
	        <form asp-action="ConfirmarPedido" asp-controller="CarritoCabecera" method="post" class="d-inline">
	          <input type="hidden" name="solicitarFactura" value="false" />
	          <button type="submit" class="btn btn-secondary">No solicitar factura</button>
	        </form>
	      </div>
	    </div>
	  </div>
	</div>
</div>
